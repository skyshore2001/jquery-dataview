
function jquery_dataView($)
{var m_version='1.0';var m_exposed={getData:getData,version:function(jo){return m_version;}};var m_defaults={props:{},events:{}};var m_ifstack=[];var m_ifval=false;function getData(jo,exact,ret)
{var dvData;while(true){dvData=jo.data("dvData_");if(exact||dvData!==undefined)
break;jo=jo.parent();if(jo.size()==0)
break;}
if(ret){ret.data=dvData;ret.opt=jo.data("dvOpt_");ret.jo=jo;}
return dvData;}
function setData(jo,data,opt)
{jo.data("dvData_",data);if(opt)
jo.data("dvOpt_",opt);}
function setDataView(jo,data,opt,doInit,doSetData)
{if(jo.size()==0)
return jo;var vfor;if(doInit&&(vfor=jo.attr("dv-for"))){var isThis=(vfor=='this');var arrData=isThis?data:data[vfor];if(!$.isArray(arrData)){console.log("!!! warn: not array: "+vfor);return $([]);}
var opt1;if(!isThis){opt1=(opt.children&&opt.children[vfor])||{};opt1.events=opt.events;}
else{opt1=opt;}
var joRet=$([]);var jtpl=jo.data("dv-template");if(jtpl==null)
jtpl=jo;$.each(arrData,function(i,data1){var jo1=jtpl.clone();jo1.removeAttr("dv-for");if(!isThis)
data1.$parent=data;jo1=setDataView(jo1,data1,opt1,doInit,true);jo1.attr("dv-expanded","");jo1.insertBefore(jo);joRet=joRet.add(jo1);});if(jtpl===jo){$("<span></span>").attr("dv-for",vfor).hide().data("dv-template",jo).insertBefore(jo);jo.remove();}
return joRet;}
if(doInit&&doSetData){setData(jo,data,opt);if(opt.props){$.extend(data,opt.props);}}
if(!doInit){var rv={};if(getData(jo,null,rv)==null)
$.error("*** dataview does not init");opt=rv.opt;data=rv.data;}
var val,val1;if(doInit){if(val=jo.attr("dv-if")){val1=!!evalWithin(data,val);m_ifval=val1;if(!m_ifval){jo.remove();return $([]);}
jo.removeAttr("dv-if");}
else if(val=jo.attr("dv-elseif")){if(m_ifval){jo.remove();return $([]);}
m_ifval=!!evalWithin(data,val);if(!m_ifval){jo.remove();return $([]);}
jo.removeAttr("dv-elseif");}
else if((val=jo.attr("dv-else"))!=null){if(m_ifval){jo.remove();return $([]);}
jo.removeAttr("dv-else");}}
if(val=jo.attr("dv-show")){val1=!!evalWithin(data,val);jo.toggle(val1);}
if(doInit&&(val=jo.attr("dv-on"))){$.each(val.split(/\s*,\s*/),function(){var fname=this.toString();var fn=opt.events[fname];if(fn==null){$.error("*** no event handler: "+fname);}
if(ms=fname.match(/_(\w+)/)){jo.off(ms[1]).on(ms[1],data,fn);}});}
if(jo.attr("name")){setItemContentByName(jo,data,opt);}
if(doInit){m_ifstack.push(m_ifval);m_ifval=false;}
$.each(jo.children(),function(i,child){setDataView($(child),data,opt,doInit);});if(doInit){m_ifval=m_ifstack.pop();}
return jo;}
function evalWithin(data,code__080909)
{try{with(data){return eval(code__080909);}}catch(ex){return;}}
function evalSimple(data,name)
{return eval('data.'+name);}
function setItemContentByName(ji,data,opt)
{var name=ji.attr("name");var fmt=ji.attr("dv-format");var content=null;if(name.indexOf('.')<0){content=data[name];}
else{content=evalSimple(data,name);}
if($.isFunction(content)){content=content.call(data);}
if(fmt){var fn=opt&&opt.formats&&opt.formats[fmt];if(fn==null){$.error("*** no format for item [name="+name+"]: "+fmt);}
content=fn.call(data,content);}
setItemContent(ji,content);}
function setItemContent(ji,content)
{var isInput=ji.is(":input");if(content===undefined){if(isInput){if(ji[0].tagName==="TEXTAREA")
content=ji.html();else
content=ji.attr("value");if(content===undefined)
content="";}
else{content="";}}
if(ji.is(":input")){ji.val(content);}
else{ji.html(content);}}
$.fn.extend({dataview:function(data,opt){if(typeof(data)=="string")
{if(!m_exposed[data])
$.error("*** unknown call: "+data);var fn=m_exposed[data];arguments[0]=this;return fn.apply(this,arguments);}
var isBound=(getData(this)!=null);if(data==null&&isBound)
return setDataView(this);var opt1=$.extend({},m_defaults,opt);if(this.size()!=1){$.error("*** dataview: MUST only one DOM object.");}
if(isBound){this.find("[dv-expanded]").remove();}
return setDataView(this,data,opt1,true,true);}});$.fn.dataview.defaults=m_defaults;}
jquery_dataView(window.jQuery);